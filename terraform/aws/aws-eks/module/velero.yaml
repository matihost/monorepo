# helm show values vmware-tanzu/velero

image:
  repository: velero/velero
  tag: latest
  pullPolicy: Always

podAnnotations:
  ad.datadoghq.com/velero.checks: |
    {
      "velero": {
        "init_config": {},
        "instances": [{"openmetrics_endpoint": "http://%%host%%:8085/metrics"}]
      }
    }
  ad.datadoghq.com/node-agent.checks: |
    {
      "velero": {
        "init_config": {},
        "instances": [{"openmetrics_endpoint": "http://%%host%%:8085/metrics"}]
      }
    }

nodeSelector:
  karpenter.sh/nodepool: "system"

tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
  - effect: "NoExecute"
    operator: "Exists"
    tolerationSeconds: 300

# For AWS
# configuration:
#   backupStorageLocation:
#   - bucket: $BUCKET
#     provider: aws
#   volumeSnapshotLocation:
#   - config:
#       region: $REGION
#     provider: aws
# Init containers to add to the Velero deployment's pod spec. At least one plugin provider image is required.
# If the value is a string then it is evaluated as a template.
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:latest
    imagePullPolicy: Always
    volumeMounts:
      - mountPath: /target
        name: plugins

credentials:
  # Whether a secret should be used. Set to false if, for examples:
  # - using kube2iam or kiam to provide AWS IAM credentials instead of providing the key file. (AWS only)
  # - using workload identity instead of providing the key file. (Azure/GCP only)
  useSecret: false

# TODO Velero does not support EUSC
#  message: 'BackupStorageLocation "default" is unavailable: rpc error: code = Unknown
#  desc = operation error S3: ListObjectsV2, get identity: get credentials: failed
#  to refresh cached credentials, failed to retrieve credentials, operation error
#  STS: AssumeRoleWithWebIdentity, https response error StatusCode: 0, RequestID:
#  , request send failed, Post "https://sts.eusc-de-east-1.amazonaws.com/": dial
#  tcp: lookup sts.eusc-de-east-1.amazonaws.com on 172.30.0.10:53: no such host'

# IRSA for Velero
# serviceAccount:
#   server:
#     annotations:
#       eks.amazonaws.com/role-arn: "arn:${AWS_PARTITION}:iam::${ACCOUNT}:role/eks-velero-backup"

# init container uses bitnamilegacy image - but it is no more working
kubectl:
  image:
    repository: docker.io/bitnamilegacy/kubectl
    tag: latest

configuration:
  # Must have to
  features: EnableCSI
  # When POD has no annotation like: backup.velero.io/backup-volumes: <<name-of-volume-in-the-pod>>
  # then if it is EBS and VolumeSnapshotClass with
  # label velero.io/csi-volumesnapshot-class=true exists
  # velero will use it to snapshot EBS volumes.
  # Otherwise EFS volumes will be skipped in backup.
  #
  # If defaultVolumesToFsBackup is true then all volumes
  # without the annotation will be treated as FS volumes. EBS volumes will not be snapshotted.
  defaultVolumesToFsBackup: false

# For FS backups (like EGS)
deployNodeAgent: true
nodeAgent:
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  tolerations:
    - key: "CriticalAddonsOnly"
      operator: "Exists"
    - effect: "NoExecute"
      operator: "Exists"
      tolerationSeconds: 300
